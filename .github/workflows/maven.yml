name: Java CI

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11
    - name: Build with Maven
      run: mvn -B package --file pom.xml
    - uses: actions/checkout@v1
    - run: mkdir -p target/
    - run: echo *.jar > target/api-service.jar
    - uses: actions/upload-artifact@v1
      with:
       name: api-service.jar
       path: target/
 
  deploy:
  
    needs: [build]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    - uses: actions/download-artifact@v1
      with:
          name: api-service.jar
          path: target/
    - name: Publish to registry
      uses: elgohr/Publish-Docker-Github-Action@master
      with:
        name: docker.pkg.github.com/300kks/api-service/api-service:latest
        username: ${{secrets.GITHUB_PKG_REGISTRY_USERNAME}}
        password: ${{secrets.GITHUB_PKG_REGISTRY_PASSWORD}}
        registry: docker.pkg.github.com

  delivery:
    
    needs: [deploy]
    runs-on: 'ubuntu-latest'
    
    steps:
    - uses: 'actions/checkout@v1'
    - name: 'Deploy'
      uses: 'deliverybot/helm@v1'
      with:
        helm: 'helm3'
        release: 'api-service'
        namespace: 'default'
        chart: 'chart/api-service'
        token: '${{ github.token }}'
      env:
        KUBECONFIG_FILE: '${{ secrets.KUBECONFIG }}'
